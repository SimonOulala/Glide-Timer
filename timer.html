<script>
  // --- lecture des paramètres envoyés par Glide ---
  const q = new URLSearchParams(location.search);
  const prep = Math.max(0, +q.get('prep')||0);     // Décompte (US)
  const dur  = Math.max(0, +q.get('dur')||0);      // Total Sec (US)
  const startStr = q.get('start');
  const start = startStr ? new Date(startStr).getTime() : Date.now();

  const phaseEl = document.getElementById('phase');
  const timeEl  = document.getElementById('time');

  // --- utilitaires d'affichage ---
  const fmt = (s)=>{
    s = Math.max(0, Math.floor(s));
    const m = Math.floor(s/60).toString().padStart(2,'0');
    const sec = (s%60).toString().padStart(2,'0');
    return `${m}:${sec}`;
  };

  // --- générateur de son ---
  const tone = (freq=880, dur=180, vol=0.12)=>{
    try{
      const Ctx = window.AudioContext||window.webkitAudioContext;
      const ctx = new Ctx();
      const o = ctx.createOscillator(), g = ctx.createGain();
      o.connect(g); g.connect(ctx.destination);
      o.type='sine'; o.frequency.value=freq; g.gain.value=vol;
      o.start(); setTimeout(()=>{o.stop(); ctx.close();}, dur);
    }catch(e){}
  };
  const beepShort = (freq)=>tone(freq,140,0.14);   // bip court
  const beepLong  = (freq)=>tone(freq,420,0.18);   // bip long

  // --- états pour ne biper qu'une fois ---
  let lastPrepSec = null;
  let lastRunSec  = null;
  let prepDoneBeeped = false;   // long bip sur 0 de prépa
  let runDoneBeeped  = false;   // long bip sur 0 de run

  const tick = ()=>{
    const now = Date.now();
    const elapsed = (now - start)/1000;

    // calculs "restant"
    const prepRemain = Math.max(0, prep - elapsed);
    const runRemain  = Math.max(0, prep + dur - elapsed);

    // 1) LONG BIP exactement à 0 de la PRÉPA (transition vers travail)
    if (prep > 0 && !prepDoneBeeped && elapsed >= prep) {
      beepLong(900);                           // long bip prépa
      if (navigator.vibrate) navigator.vibrate([60,40,120]);
      prepDoneBeeped = true;
    }

    // 2) LONG BIP exactement à 0 du RUN (fin de travail)
    if (dur > 0 && !runDoneBeeped && elapsed >= (prep + dur)) {
      beepLong(800);                           // long bip fin
      if (navigator.vibrate) navigator.vibrate([80,60,140]);
      runDoneBeeped = true;
    }

    // PHASE PRÉPA
    if (prep > 0 && prepRemain > 0) {
      phaseEl.textContent = "Prépare toi pour l'exercice";
      timeEl.textContent  = fmt(prepRemain);

      // bips courts sur 3, 2, 1 secondes restantes (prépa)
      const s = Math.ceil(prepRemain);
      if (s !== lastPrepSec && (s===3 || s===2 || s===1)) {
        beepShort(1000);
        if (navigator.vibrate) navigator.vibrate(50);
      }
      lastPrepSec = s;
      return;
    }

    // PHASE RUN (travail)
    if (runRemain > 0) {
      phaseEl.textContent = "C'est parti !";
      timeEl.textContent  = fmt(runRemain);

      // bips courts sur 3, 2, 1 secondes restantes (travail)
      const s = Math.ceil(runRemain);
      if (s !== lastRunSec && (s===3 || s===2 || s===1)) {
        beepShort(1200);
        if (navigator.vibrate) navigator.vibrate(50);
      }
      lastRunSec = s;
      return;
    }

    // FIN (après le long bip déjà joué)
    phaseEl.textContent = "Terminé";
    timeEl.textContent  = "00:00";
  };

  // premier rendu + tick régulier
  tick();
  const iv = setInterval(tick, 200);   // cadence suffisante pour rater aucun palier
  setTimeout(()=>clearInterval(iv), 2*60*60*1000); // sécurité 2h
</script>
